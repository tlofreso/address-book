<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lists - Address Book</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .pac-container { z-index: 10000; }
        tbody tr { cursor: pointer; }
        tbody tr:hover { background-color: rgba(255, 255, 255, 0.075); }
        .card-header { background-color: rgba(13, 110, 253, 0.15); border-bottom: 1px solid rgba(13, 110, 253, 0.3); }
        .btn-primary { background-color: #0d6efd; border-color: #0d6efd; }
        .btn-primary:hover { background-color: #0b5ed7; border-color: #0a58ca; }
        .list-card { transition: all 0.2s; }
        .list-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    </style>
</head>
<body class="bg-dark">
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Lists</h1>
            <a href="/" class="btn btn-outline-primary">Back to Households</a>
        </div>

        <!-- Create New List Button -->
        <div class="mb-4">
            <button class="btn btn-success" id="createNewListBtn">+ Create New List</button>
        </div>

        <!-- List View Toggle -->
        <div id="listsView">
            <!-- Search and Controls -->
            <div class="d-flex justify-content-between align-items-center mb-3 gap-3">
                <input type="text" class="form-control form-control-sm" style="max-width: 300px;" id="searchBox" placeholder="Search lists...">
            </div>

            <!-- Lists Container -->
            <div id="listsContainer" class="row">
                <p class="text-muted">Loading lists...</p>
            </div>
        </div>

        <!-- List Detail View (hidden by default) -->
        <div id="listDetailView" class="d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <button class="btn btn-sm btn-outline-secondary mb-2" id="backToListsBtn">‚Üê Back to Lists</button>
                    <h2 id="listDetailName"></h2>
                    <p class="text-muted mb-0" id="listDetailDescription"></p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-secondary" id="editListBtn">Edit List</button>
                    <button class="btn btn-sm btn-outline-danger" id="deleteListBtn">Delete List</button>
                </div>
            </div>

            <!-- Households in this list -->
            <div class="d-flex justify-content-between align-items-center mb-3 gap-3">
                <input type="text" class="form-control form-control-sm" style="max-width: 300px;" id="searchHouseholdsBox" placeholder="Search households...">
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-danger" id="removeSelectedBtn" disabled>Remove Selected</button>
                    <select class="form-select form-select-sm w-auto" id="perPage">
                        <option value="20" selected>20 per page</option>
                        <option value="50">50 per page</option>
                        <option value="100">100 per page</option>
                        <option value="999999">All</option>
                    </select>
                </div>
            </div>

            <table class="table table-hover">
                <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" id="selectAll" class="form-check-input">
                        </th>
                        <th>Household Name</th>
                        <th>Address</th>
                        <th>Members</th>
                    </tr>
                </thead>
                <tbody id="householdsTable"></tbody>
            </table>

            <nav>
                <ul class="pagination justify-content-center" id="pagination"></ul>
            </nav>
        </div>
    </div>

    <!-- Create/Edit List Modal -->
    <div class="modal fade" id="listFormModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="listFormTitle">Create List</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="listForm">
                        <input type="hidden" id="listFormId">
                        <div class="mb-3">
                            <label class="form-label">List Name</label>
                            <input type="text" class="form-control" id="listFormName" placeholder="e.g., Christmas Cards, Theo's Birthday Party" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description (optional)</label>
                            <textarea class="form-control" id="listFormDescription" rows="2" placeholder="Optional description"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="saveListBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let listFormModal;
        let allLists = [];
        let currentList = null;
        let allHouseholds = [];
        let filteredHouseholds = [];
        let selectedHouseholds = new Set();
        let currentPage = 1;
        let perPage = 20;

        async function init() {
            await loadLists();
            setupEventListeners();
        }

        function setupEventListeners() {
            document.getElementById('createNewListBtn').addEventListener('click', () => showListForm());
            document.getElementById('saveListBtn').addEventListener('click', saveList);
            document.getElementById('backToListsBtn').addEventListener('click', showListsView);
            document.getElementById('editListBtn').addEventListener('click', () => showListForm(currentList));
            document.getElementById('deleteListBtn').addEventListener('click', deleteCurrentList);
            document.getElementById('searchBox').addEventListener('input', filterLists);
            document.getElementById('searchHouseholdsBox').addEventListener('input', filterHouseholds);
            document.getElementById('perPage').addEventListener('change', (e) => {
                perPage = parseInt(e.target.value);
                filterHouseholds();
            });
            document.getElementById('selectAll').addEventListener('change', toggleSelectAll);
            document.getElementById('removeSelectedBtn').addEventListener('click', removeSelectedHouseholds);
        }

        async function loadLists() {
            const response = await fetch('/lists/');
            allLists = await response.json();
            renderLists();
        }

        function filterLists() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const filtered = allLists.filter(list =>
                list.name.toLowerCase().includes(searchTerm) ||
                (list.description && list.description.toLowerCase().includes(searchTerm))
            );
            renderLists(filtered);
        }

        function renderLists(lists = allLists) {
            const container = document.getElementById('listsContainer');

            if (lists.length === 0) {
                container.innerHTML = '<div class="col-12"><p class="text-muted">No lists found. Create one to get started!</p></div>';
                return;
            }

            container.innerHTML = lists.map(list => `
                <div class="col-md-4 mb-3">
                    <div class="card list-card" onclick="viewList(${list.id})" style="cursor: pointer;">
                        <div class="card-body">
                            <h5 class="card-title">${list.name}</h5>
                            ${list.description ? `<p class="card-text text-muted small">${list.description}</p>` : ''}
                            <p class="card-text">
                                <small class="text-muted">${list.household_count} household(s)</small>
                            </p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function viewList(listId) {
            const response = await fetch(`/lists/${listId}`);
            currentList = await response.json();

            document.getElementById('listDetailName').textContent = currentList.name;
            document.getElementById('listDetailDescription').textContent = currentList.description || '';

            allHouseholds = currentList.households;
            selectedHouseholds.clear();
            filterHouseholds();

            document.getElementById('listsView').classList.add('d-none');
            document.getElementById('listDetailView').classList.remove('d-none');
        }

        function showListsView() {
            document.getElementById('listDetailView').classList.add('d-none');
            document.getElementById('listsView').classList.remove('d-none');
            loadLists();
        }

        function filterHouseholds() {
            const searchTerm = document.getElementById('searchHouseholdsBox').value.toLowerCase();
            filteredHouseholds = allHouseholds.filter(household => {
                const name = household.name.toLowerCase();
                const address = (household.address || '').toLowerCase();
                const memberNames = household.members.map(m => `${m.first_name} ${m.last_name}`.toLowerCase()).join(' ');
                return name.includes(searchTerm) || address.includes(searchTerm) || memberNames.includes(searchTerm);
            });

            currentPage = 1;
            renderHouseholds();
            renderPagination();
        }

        function renderHouseholds() {
            const start = (currentPage - 1) * perPage;
            const end = perPage === 999999 ? filteredHouseholds.length : start + perPage;
            const pageHouseholds = filteredHouseholds.slice(start, end);

            const tableBody = document.getElementById('householdsTable');
            if (pageHouseholds.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-muted text-center">No households in this list</td></tr>';
                return;
            }

            tableBody.innerHTML = pageHouseholds.map(household => {
                const membersList = household.members.map(m => `${m.first_name} ${m.last_name}`).join(', ');
                const isChecked = selectedHouseholds.has(household.id) ? 'checked' : '';
                return `
                    <tr>
                        <td onclick="event.stopPropagation()">
                            <input type="checkbox" class="form-check-input household-checkbox"
                                   data-household-id="${household.id}" ${isChecked}
                                   onchange="toggleHouseholdSelection(${household.id})">
                        </td>
                        <td>${household.name}</td>
                        <td>${household.address || ''}</td>
                        <td>${membersList || '<span class="text-muted">No members</span>'}</td>
                    </tr>
                `;
            }).join('');

            updateRemoveButton();
        }

        function toggleHouseholdSelection(householdId) {
            if (selectedHouseholds.has(householdId)) {
                selectedHouseholds.delete(householdId);
            } else {
                selectedHouseholds.add(householdId);
            }
            updateRemoveButton();
            updateSelectAllCheckbox();
        }

        function toggleSelectAll(e) {
            const pageHouseholds = filteredHouseholds.slice(
                (currentPage - 1) * perPage,
                perPage === 999999 ? filteredHouseholds.length : currentPage * perPage
            );

            if (e.target.checked) {
                pageHouseholds.forEach(h => selectedHouseholds.add(h.id));
            } else {
                pageHouseholds.forEach(h => selectedHouseholds.delete(h.id));
            }

            renderHouseholds();
        }

        function updateRemoveButton() {
            const removeBtn = document.getElementById('removeSelectedBtn');
            removeBtn.disabled = selectedHouseholds.size === 0;
        }

        function updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const visibleHouseholds = filteredHouseholds.map(h => h.id);
            const allVisibleSelected = visibleHouseholds.length > 0 &&
                                       visibleHouseholds.every(id => selectedHouseholds.has(id));
            selectAllCheckbox.checked = allVisibleSelected;
        }

        async function removeSelectedHouseholds() {
            if (!confirm(`Remove ${selectedHouseholds.size} household(s) from this list?`)) return;

            const removePromises = Array.from(selectedHouseholds).map(householdId =>
                fetch(`/lists/${currentList.id}/households/${householdId}`, { method: 'DELETE' })
            );

            await Promise.all(removePromises);
            selectedHouseholds.clear();
            await viewList(currentList.id);
        }

        function renderPagination() {
            const totalPages = Math.ceil(filteredHouseholds.length / perPage);
            const paginationEl = document.getElementById('pagination');

            if (totalPages <= 1 || perPage === 999999) {
                paginationEl.innerHTML = '';
                return;
            }

            let html = '';

            html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Previous</a>
            </li>`;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                    </li>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Next</a>
            </li>`;

            paginationEl.innerHTML = html;
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredHouseholds.length / perPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderHouseholds();
            renderPagination();
        }

        function showListForm(list = null) {
            document.getElementById('listFormId').value = list ? list.id : '';
            document.getElementById('listFormName').value = list ? list.name : '';
            document.getElementById('listFormDescription').value = list ? (list.description || '') : '';
            document.getElementById('listFormTitle').textContent = list ? 'Edit List' : 'Create List';

            if (!listFormModal) {
                listFormModal = new bootstrap.Modal(document.getElementById('listFormModal'));
            }
            listFormModal.show();
        }

        async function saveList() {
            const id = document.getElementById('listFormId').value;
            const name = document.getElementById('listFormName').value;
            const description = document.getElementById('listFormDescription').value;

            if (!name) {
                alert('Please enter a list name');
                return;
            }

            const listData = { name, description: description || null };

            if (id) {
                await fetch(`/lists/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(listData)
                });
            } else {
                await fetch('/lists/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(listData)
                });
            }

            if (listFormModal) {
                listFormModal.hide();
            }

            await loadLists();
        }

        async function deleteCurrentList() {
            if (!confirm(`Are you sure you want to delete "${currentList.name}"?`)) return;

            await fetch(`/lists/${currentList.id}`, { method: 'DELETE' });
            showListsView();
        }

        init();
    </script>
</body>
</html>
